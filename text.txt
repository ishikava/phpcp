интеграция криптопро с пхп7

зачем:
криптопро нужен для цифровой подписи по гост
это нужно для смэв
не простая интеграция с пхп

что такое:
криптопро
смэв
гост14

установка:

использование:

ссылки:


что такое крипро и для чего он нужен

почему не использовать опенссл = шосты

где брать инфо = ссылка на девелоперс

интеграция с пхп = процесс


1. Что такое крипро и для чего он нужен?

КриптоПро - это отечественный криптопровайдер (набор криптографических утилит), который используется для генерации электронной подписи, шифрования и работы с сертификатами, с поддержкой алгоритмов ГОСТ Р 34.10-2012.

2. почему не использовать привычный OpenSSL?

OpenSSL имеет ограниченную поддержку алгоритмов ГОСТ и с его помощью невозможно корректно подписать XML документ в формате XMLDsign который требуется в частности для осуществления электронного документооборота через шину СМЭВ.

3. Что такое СМЭВ

СМЭВ - это система межведомственного электронного взаимодействия, которая обеспечивает возможность безопасной передачи документов и сообщений в защищенной сети.
Сервисами СМЭВ активно пользуются региональные и федеральные органы власти, а так-же коммерческие организации, такие как МФЦ.

Для чего понадобилась интеграция CryptoPro с php?

Перед нами была поставлена задача создания внутреннего сервиса, осуществляющего прием и передачу документов и электронных сообщений через СМЭВ для местного ОВ.
Так-как основная экспертиза в нашей компании - это написание web-сервисов на php и Go, было принято решение использовать php7
Как показала практика - php плохо подходит для данной задачи, но сроки пождимали, JAVA или .NET программиста в команде не было.
Нам пришлось в сжатые сроки находить решение для php.

Первая проблема, с которой мы столкнулись - практически полное отсутствие документации, статей и просто ссылок на источники знаний в интернете по данному вопросу.
Чтобы облегчить вам этот путь, сразу даю ссылки на правильные источники знаний:
CryptoPro Developer Network: https://cpdn.cryptopro.ru
Данный справочник написан для .NET и С.
Я вам советую сразу перейти в: КриптоПро ЭЦП. Руководство разработчика -> Справочник по ЭЦП SDK -> Интерфейс COM -> CAdESCOM: Интерфейсы
Там можно ознакомиться с базовыми методами плагина CryptoPro и понять логику работы утилит.
Пока у меня не было доступа к этому справочнику - нам приходилось изучать исходники CryptoPro плагина, чтобы хоть как-то заставить его работать.

В теории реализация методов CADES в PHP плагине должна соответствовать реализации CADES от Microsoft
Для примера вот тут я искал названия полей для поиска сертификата:
https://docs.microsoft.com/en-us/windows/win32/seccrypto/certificates-find

Далее вам предстоит скачать и установить набор утилит CryptoPro CSP 5: https://www.cryptopro.ru/products/csp_5_0_
Процесс установки тривиален и хорошо описан на официальном сайте.
После установки на платформе Linux вы получите небольшой набор утилит, которые собственно и есть - Криптопро:

Утилита certmgr: https://www.cryptopro.ru/sites/default/files/docs/certmgr.pdf
предназначена для управления сертификатами и ключами в системе.
информация об использовании : certmgr -help

Установить сертификаты для текущего пользователя:
/opt/cprocsp/bin/amd64/certmgr -install -pfx -f /mnt/usb/gost12.pfx -pin 12345

Утилита cryptcp: https://www.cryptopro.ru/products/other/cryptcp
предназначина для генерации и валидации ЭЦП, шифрования, хэширования
информация об использовании : cryptcp -help 

Пример подписания документа: /opt/cprocsp/bin/amd64/cryptcp -sign -thumbprint 626f2a33c6798681626ecf80a1f3ef2b18c96fbd in.txt

Если вам не нужен механизм XMLDsign, то базового набора утилит вполне достаточно для полноценной работы из командной строки или при помощи простейших bash скриптов.
Но для нашей задачи было необходимо создать клиент-серверное приложение способное "общаться" через шину СМЭВ по протоколу SOAP.

В простейшем случае передача данных через СМЭВ выглядит как обмен подписанными XML сообщениями - SOAP конвертами.
Вот пример простейшего валидного SOAP конверта:

........

Именно для создания таких конвертов нам потребовалось написать наш сервис на PHP и CryptoPro.

* Произвести валидацию цифровой подписи и структуры электронного сообщения на соответствие схемем СМЭВ можно здесь:
https://smev.gosuslugi.ru/portal/services-tools.jsp

В чем сложность интеграции КриптоПро и PHP?
Во первых, отсутствие документации к плагину.
Во вторых, отсутствие поддержки PHP7+ без специального патча и танцев с бубном.

Перейдем собственно к установке нашей гремучей связки CryptoPro CSP 5 + PHP7.3:

1. Скачать и установить сам КриптоПро CSP 5:
/Cryptopro CSP 5/linux-amd64_deb.tgz tar -xvf linux-amd64_deb.tgz
bash install.sh

2. Сборка php с поддержкой Cryptopro Cades

1. Скачать и установить CryptoPro CADES для Linux : https://cpdn.cryptopro.ru/content/cades/plugin-installation-unix.html

dpkg -i cprocsp-pki-cades_2.0.0-1_amd64.deb

dpkg -i lsb-cprocsp-devel_5.0.11535-4_all.deb

dpkg -i cprocsp-pki-plugin_2.0.0-1_amd64.deb

dpkg -i cprocsp-pki-phpcades_2.0.0-1_amd64.deb

2. Скачать исходники php нужной версии: https://www.php.net/releases/index.php
Переходим в папку с исходниками php и выполняем команду ./configure
Внимательно читаем вывод, если установщику не хватает каких-то пакетов - доустанавливаем
У меня обычно ругается на отсутствие libxml2:

apt-get install libxml2

apt-get install libxml2-dev

Переходим в папку с исходниками phpcades Криптопро
cd /opt/cprocsp/src/phpcades

Копируем сюда патч php7_support.patch (он фиксит пути для поддержки php7, по умолчанию криптопрошная phpcades работает только с php5.6)

Выполнить

patch -p0 < ./php7_support.patch

В Makefile.unix указать путь до папки с исходниками (пример : PHPDIR=/home/tesonero/ovirug/install/php)

Выполнить

eval `/opt/cprocsp/src/doxygen/CSP/../setenv.sh --64`; make -f Makefile.unix

Скорее всего будет ругаться на отсутствие libboost, поставим

apt install libboost-all-dev

После успешной компиляции должен появиться файл libphpcades.so

Находим папку с экстеншенами php
php-config --extension-dir или php -i | grep extension_dir

Копируем туда libphpcades.so или ставим симлинк

Активируем экстеншен прописать libphpcades.ini в /etc/php/7.2/mods_available прописать libphpcades.ini /etc/php/7.2/fpm/conf.d

service php7.2-fpm restart

3. Установка сертификатов в систему:

информация о генерации ключей и получении сертификатов вынесены за пределы данной статьи, пожалуйста ознакомьтесь с этой темой самомтоятельно. Информации в интернете предостаточно.




